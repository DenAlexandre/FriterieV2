@page "/register"
@using Friterie.BlazorServer.Services
@inject ApiServiceView ApiService
@inject NavigationManager Navigation

<PageTitle>Inscription - Friterie</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-body p-5">
                    <h3 class="card-title text-center mb-4">📝 Créer un compte</h3>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>@successMessage
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prénom *</label>
                            <input type="text" class="form-control" @bind="firstName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom *</label>
                            <input type="text" class="form-control" @bind="lastName" required />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" @bind="email" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Téléphone *</label>
                        <input type="tel" class="form-control" @bind="phoneNumber"
                               placeholder="+33 6 12 34 56 78" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Adresse de livraison *</label>
                        <textarea class="form-control" @bind="address" rows="2"
                                  placeholder="Numéro, rue, ville, code postal" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control" @bind="password" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirmer *</label>
                            <input type="password" class="form-control" @bind="confirmPassword" required />
                        </div>
                    </div>

                    <button class="btn btn-success btn-lg w-100 mt-3"
                            @onclick="HandleRegister"
                            disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        S'inscrire
                    </button>

                    <hr class="mt-4" />

                    <div class="text-center">
                        <p class="mb-0">Déjà inscrit ?</p>
                        <a href="/login" class="btn btn-outline-primary mt-2">Se connecter</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string firstName = "";
    private string lastName = "";
    private string phoneNumber = "";
    private string address = "";
    private string errorMessage = "";
    private string successMessage = "";
    private bool isLoading = false;


    private async Task HandleRegister()
    {
        isLoading = true;
        errorMessage = "";
        successMessage = "";

        // Validation
        if (string.IsNullOrWhiteSpace(firstName) || string.IsNullOrWhiteSpace(lastName) ||
            string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password) ||
            string.IsNullOrWhiteSpace(phoneNumber) || string.IsNullOrWhiteSpace(address))
        {
            errorMessage = "Tous les champs sont obligatoires";
            isLoading = false;
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "Les mots de passe ne correspondent pas";
            isLoading = false;
            return;
        }

        if (password.Length < 6)
        {
            errorMessage = "Le mot de passe doit contenir au moins 6 caractères";
            isLoading = false;
            return;
        }

        try
        {
            var request = new RegisterRequest
            {
                Email = email,
                Password = password,
                FirstName = firstName,
                LastName = lastName,
                PhoneNumber = phoneNumber,
                Address = address
            };

            var success = await ApiService.RegisterAsync(request);

            if (success)
            {
                successMessage = "Inscription réussie ! Redirection vers la connexion...";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Un compte avec cet email existe déjà";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erreur lors de l'inscription. Veuillez réessayer.";
        }
        finally
        {
            isLoading = false;
        }
    }
}