@page "/burgers"

 
@using Friterie.BlazorServer.Services
@using Friterie.Services

@inject ProductService ProductServiceView
@inject CartService CartService

<PageTitle>Plats</PageTitle>

<h1>Choix des Burgers</h1>

<div class="maitre-detail">

    <!-- SECTION LISTE : plats selon la catégorie -->
    <div class="liste">

            <h3>Burgers</h3>
            <ul class="categories">
            @foreach (var burger_item in _burgers)
                {
                <li class="@(burger_item.Id == _productSelectionne?.Id ? "selected" : "")"
                        @onclick="@(() => ChangerBurger(burger_item))">
                        @burger_item.Name
                    </li>
                }
            </ul>

    </div>

    <!-- SECTION DÉTAIL -->
    <div class="detail">
        <h3>Détail</h3>
        @if (_productSelectionne != null)
        {


            <div class="card-body d-flex flex-column">
                <img src="@_productSelectionne.ImageUrl" alt="@_productSelectionne.Name" class="image-detail" />
                <h5 class="card-title">@_productSelectionne.Name</h5>
                <p class="card-text text-muted small flex-grow-1">@_productSelectionne.Description</p>
                <div class="mb-2">
                    <span class="badge bg-secondary">@_productSelectionne.TypeProduct.TypeProductNom</span>
                    @if (_productSelectionne.Stock < 10)
                    {
                        <span class="badge bg-warning text-dark">Stock limité</span>
                    }
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <strong class="text-success fs-5">@_productSelectionne.Price.ToString("C")</strong>
                    @if (_productSelectionne.IsAvailable && _productSelectionne.Stock > 0)
                    {
                        <button class="btn btn-primary btn-sm" @onclick="() => AddToCart(_productSelectionne)">
                            <i class="bi bi-cart-plus"></i> Ajouter
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-secondary btn-sm" disabled>
                            Rupture
                        </button>
                    }
                </div>
            </div>
        }
        else
        {
            <p><em>Sélectionnez un plat pour voir les détails.</em></p>
        }
    </div>

    


</div>

@code {

    const int CATEGORIE = 1;

    private List<Product> _burgers = new();
    private Product? _productSelectionne;



    protected override async Task OnInitializedAsync()
    {
        _burgers = await ProductServiceView.GetProductsAsync(CATEGORIE, 1000, 0);

        //FiltrerCategorie();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (_productSelectionne == null)
        {
            _productSelectionne = _burgers.FirstOrDefault();
            InvokeAsync(StateHasChanged);
        }


        base.OnAfterRender(firstRender);
    }


    private void ChangerBurger(Product product)
    {
        // categorieSelectionnee = categorie;
        _productSelectionne = _burgers.FirstOrDefault(x=>x.Id == product.Id);
        // FiltrerCategorie();
    }

    private void SelectionnerBurger(Product product)
    {
        _productSelectionne = product;
    }

    private void AddToCart(Product product)
    {
        CartService.AddItem(product);
    }

    public void Dispose()
    {
        // CartService.OnChange -= StateHasChanged;
    }


}
