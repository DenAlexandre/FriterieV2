@page "/checkout"
@using Friterie.BlazorServer.Services
@inject CartService CartService
@inject ApiService ApiService
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Paiement - Friterie</PageTitle>

<div class="container my-5">
    @if (!AuthState.IsAuthenticated)
    {
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
            <p class="mb-3">Vous devez être connecté pour passer commande</p>
            <a href="/login" class="btn btn-primary">Se connecter</a>
        </div>
    }
    else if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Traitement...</span>
            </div>
            <p class="mt-3 fs-5">Traitement du paiement en cours...</p>
            <p class="text-muted">Veuillez patienter, ne fermez pas cette page</p>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-credit-card me-2"></i>Paiement Sécurisé</h4>
                    </div>
                    <div class="card-body p-4">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Erreur:</strong> @errorMessage
                                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                            </div>
                        }

                        <div id="payment-element" class="mb-4">
                            <!-- Stripe injectera le formulaire ici -->
                        </div>

                        <button class="btn btn-success btn-lg w-100" @onclick="HandlePayment">
                            <i class="bi bi-lock-fill me-2"></i>Payer @totalAmount.ToString("C")
                        </button>

                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>
                                Paiement 100% sécurisé par Stripe
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Récapitulatif</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var item in cartItems)
                        {
                            <div class="d-flex justify-content-between mb-2 small">
                                <span>@item.ProductName x @item.Quantity</span>
                                <strong>@((item.Price * item.Quantity).ToString("C"))</strong>
                            </div>
                        }
                        <hr />
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong class="text-success fs-5">@totalAmount.ToString("C")</strong>
                        </div>
                    </div>
                </div>

                <div class="card shadow mt-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle me-2"></i>Informations</h6>
                        <ul class="small mb-0">
                            <li>Livraison gratuite</li>
                            <li>Paiement sécurisé</li>
                            <li>Préparation immédiate</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<CartItem> cartItems = new();
    private decimal totalAmount;
    private string? clientSecret;
    private string? paymentIntentId;
    private string? errorMessage;
    private bool isProcessing;
    private int orderId;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            return;
        }

        cartItems = CartService.GetItems();

        if (!cartItems.Any())
        {
            Navigation.NavigateTo("/cart");
            return;
        }

        totalAmount = CartService.GetTotal();

        try
        {
            // Créer la commande
            var items = cartItems.Select(i => new OrderItem
            {
                OiProductId = i.ProductId,
                OiProductName = i.ProductName,
                OiQuantity = i.Quantity,
                OiPrice = i.Price,
            }).ToList();

            var order = await ApiService.CreateOrderAsync(items);

            if (order != null)
            {
                orderId = order.OrderId;

                // Créer le PaymentIntent
                var paymentIntent = await ApiService.CreatePaymentIntentAsync(totalAmount);
                if (paymentIntent != null)
                {
                    clientSecret = paymentIntent.ClientSecret;
                    paymentIntentId = paymentIntent.PaymentIntentId;
                }
                else
                {
                    errorMessage = "Erreur lors de l'initialisation du paiement";
                }
            }
            else
            {
                errorMessage = "Erreur lors de la création de la commande";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(clientSecret))
        {
            try
            {
                await JS.InvokeVoidAsync("initializeStripe", clientSecret);
            }
            catch (Exception ex)
            {
                errorMessage = $"Erreur d'initialisation Stripe: {ex.Message}";
            }
        }
    }

    private async Task HandlePayment()
    {
        isProcessing = true;
        errorMessage = null;

        try
        {
            var result = await JS.InvokeAsync<PaymentResult>("submitPayment");

            if (result.Success && result.PaymentIntentId != null)
            {
                // Confirmer le paiement côté serveur
                var confirmed = await ApiService.ConfirmPaymentAsync(orderId, result.PaymentIntentId);

                if (confirmed)
                {
                    CartService.Clear();
                    Navigation.NavigateTo($"/order-confirmation/{orderId}");
                }
                else
                {
                    errorMessage = "Erreur lors de la confirmation du paiement";
                }
            }
            else
            {
                errorMessage = result.Error ?? "Erreur de paiement";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private class PaymentResult
    {
        public bool Success { get; set; }
        public string? PaymentIntentId { get; set; }
        public string? Error { get; set; }
    }
}