@page "/produits-edit"
@using System.Globalization
@using Blazorise.DataGrid
@using MudBlazor
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Administrator")]

<h3 class="mb-4">📦 Produits (édition inline)</h3>

<MudTable Items="ProduitsList"
          Hover="true"
          Bordered="true"
          Striped="true"
          Dense="true" 
          CanCancelEdit="false">

    <HeaderContent>
        <MudTh>Nom</MudTh>
        <MudTh>Catégorie</MudTh>
        <MudTh>Prix (€)</MudTh>
        <MudTh></MudTh> <!-- Actions -->
    </HeaderContent>

    <RowTemplate>
        <MudTd>
            <MudTextField @bind-Value="context.Nom" Immediate="true" />
        </MudTd>
        <MudTd>
            <MudTextField @bind-Value="context.Categorie" Immediate="true" />
        </MudTd>
        <MudTd>
            <MudNumericField @bind-Value="context.Prix" Immediate="true" />
        </MudTd>
        <MudTd>
            <MudButton Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled"
                       OnClick="() => SaveItem(context)">
                💾 Sauvegarder
            </MudButton>
            <MudButton Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined" Class="ms-2"
                       OnClick="() => CancelEdit(context)">
                ❌ Annuler
            </MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>




@code {
    private List<Produit> ProduitsList = new()
    {
        new Produit{ Nom="Pomme", Categorie="Fruit", Prix=1.20m },
        new Produit{ Nom="Banane", Categorie="Fruit", Prix=0.80m },
        new Produit{ Nom="Tomate", Categorie="Légume", Prix=2.50m },
        new Produit{ Nom="Carotte", Categorie="Légume", Prix=1.00m },
        new Produit{ Nom="Steak", Categorie="Viande", Prix=8.90m }
    };



    // Pour gérer l'annulation
    private Dictionary<Produit, Produit> Backup = new();


    private void SaveItem(Produit item)
    {
        if (Backup.ContainsKey(item))
            Backup.Remove(item);

        Snackbar.Add($"Produit '{item.Nom}' sauvegardé ✅", Severity.Success);
    }

    private void CancelEdit(Produit item)
    {
        if (Backup.TryGetValue(item, out var original))
        {
            item.Nom = original.Nom;
            item.Categorie = original.Categorie;
            item.Prix = original.Prix;
            Backup.Remove(item);
        }
        else
        {
            // Si pas de backup, on copie l'état actuel
            Backup[item] = new Produit { Nom = item.Nom, Categorie = item.Categorie, Prix = item.Prix };
        }
    }

    public class Produit
    {
        public string Nom { get; set; } = "";
        public string Categorie { get; set; } = "";
        public decimal Prix { get; set; }
    }
}
